<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Data Display</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .data-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .data-group {
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 5px;
            background-color: #f9f9f9;
            min-width: 300px;
        }
        .data-group h2 {
            margin-top: 0;
            color: #333;
        }
        pre {
            background-color: #eee;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        #error-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #ffebee;
            padding: 10px;
            border-top: 2px solid #f44336;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
    </style>
</head>
<body>
    <h1>Real-time Data Display</h1>
    <button onclick="showErrors()">Show Errors</button>
    <div id="data-container" class="data-container"></div>
    <div id="error-panel">
        <h3>WebSocket Errors <button onclick="document.getElementById('error-panel').style.display='none'">Hide</button></h3>
        <div id="error-content"></div>
    </div>

    <script>
        // Store WebSocket errors for inspection
        window.wsErrors = [];
        const dataContainer = document.getElementById('data-container');
        const dataGroups = {};
        
        // Function to render all data groups
        function renderDataGroups() {
            dataContainer.innerHTML = '';
            
            for (const [id, data] of Object.entries(dataGroups)) {
                const groupElement = document.createElement('div');
                groupElement.className = 'data-group';
                
                const titleElement = document.createElement('h2');
                titleElement.textContent = `ID: ${id}`;
                
                const dataElement = document.createElement('pre');
                dataElement.textContent = JSON.stringify(data, null, 2);
                
                groupElement.appendChild(titleElement);
                groupElement.appendChild(dataElement);
                dataContainer.appendChild(groupElement);
            }
        }
        
        function connectWebSocket() {
            const socket = new WebSocket(`ws://${window.location.host}`);
            
            socket.onopen = function(e) {
                console.log('WebSocket connected');
            };
            
            socket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    if (data.id !== undefined) {
                        dataGroups[data.id] = data;
                        renderDataGroups(); // Now this function exists
                    }
                } catch (e) {
                    console.error('Message parse error:', e);
                    logError({
                        type: 'parse',
                        message: e.message,
                        data: event.data,
                        timestamp: new Date()
                    });
                }
            };
            
            socket.onclose = function(event) {
                const errorMsg = `WebSocket closed: ${event.code} ${event.reason || 'No reason'}`;
                console.error(errorMsg);
                logError({
                    type: 'close',
                    code: event.code,
                    reason: event.reason,
                    wasClean: event.wasClean,
                    timestamp: new Date()
                });
                
                // Attempt reconnection after delay
                setTimeout(connectWebSocket, 3000);
            };
            
            socket.onerror = function(error) {
                const errorMsg = `WebSocket error: ${error.message || 'Unknown error'}`;
                console.error(errorMsg);
                logError({
                    type: 'error',
                    message: error.message,
                    timestamp: new Date()
                });
            };
            
            window.currentSocket = socket;
        }
        
        function logError(error) {
            window.wsErrors.push(error);
            showErrors();
        }
        
        function showErrors() {
            const panel = document.getElementById('error-panel');
            const content = document.getElementById('error-content');
            
            content.innerHTML = window.wsErrors.map(err => 
                `<div><strong>${err.timestamp.toLocaleTimeString()}</strong>: ${err.type} ${err.code || ''} ${err.message || ''}</div>`
            ).join('');
            
            panel.style.display = 'block';
        }
        
        // Make errors accessible from console
        window.showWsErrors = function() {
            console.table(window.wsErrors);
            return window.wsErrors;
        };
        
        // Initial connection
        connectWebSocket();
    </script>
</body>
</html>
